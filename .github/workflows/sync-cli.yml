name: Sync SeeYouUI to CLI

on:
  push:
    branches: [main]

jobs:
  sync-code:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout 源仓库 (see-u-ui) 到 'source' 文件夹
      - name: Checkout source (see-u-ui)
        uses: actions/checkout@v4
        with:
          path: source

      # 2️⃣ Checkout 目标仓库 (see-u-ui-cli) 到 'target' 文件夹
      - name: Checkout target (see-u-ui-cli)
        uses: actions/checkout@v4
        with:
          repository: seeyouui/see-u-ui-cli
          token: ${{ secrets.SYNC_TOKEN }} # 必须在仓库设置里配置这个 Token
          path: target
          ref: main

      # 3️⃣ 执行同步 (核心步骤)
      - name: Sync files (Root -> src)
        run: |
          echo "正在确保目标目录 target/src 存在..."
          mkdir -p target/src

          echo "开始同步：将 source/ 的所有内容同步到 target/src/ ..."

          # 使用 rsync 进行同步
          # -a: 归档模式（保留权限、时间等）
          # -v: 显示详细过程
          # --delete: 删除 target/src 中多余的文件（实现“清空旧文件”的效果）
          # --exclude: 排除 .git 目录，防止破坏目标仓库的 git 历史
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            source/ target/src/

          echo "同步完成，文件结构已更新。"

      # 4️⃣ 提交并推送到目标仓库
      - name: Commit and Push
        working-directory: target
        run: |
          # 配置 git 用户信息
          git config user.name "GitHub Action Bot"
          git config user.email "action@github.com"

          # 添加所有变更
          git add .

          # 检查是否有变更，如果没有变更则退出，避免报错
          if git diff --staged --quiet; then
            echo "检测到没有文件变化，跳过提交。"
            exit 0
          fi

          git commit -m "同步 see-u-ui $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
          echo "推送成功！"
